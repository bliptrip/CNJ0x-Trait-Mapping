---
editor_options: 
  markdown: 
    wrap: 72
---

# Results {#results}

## Correlations

### CNJ02

```{r trait-corrplots-setup, echo=FALSE, message=FALSE, include=FALSE}
    p.cnj02.c = round(readRDS(paste0(workflow,"/traits/plots/corrplot.cnj02.rds"))$corr, digits=2)
    write_csv(tibble::as_tibble(p.cnj02.c, rownames="Trait"),"../Data/publication/tables/corrplot.cnj02.csv")
    p.cnj04.c = round(readRDS(paste0(workflow,"/traits/plots/corrplot.cnj04.rds"))$corr, digits=2)
    write_csv(tibble::as_tibble(p.cnj04.c, rownames="Trait"),"../Data/publication/tables/corrplot.cnj04.csv")
```

Non-trivial strong positive (\@ref(fig:trait-corrplots-cnj02-refined)A)
and negative (\@ref(fig:trait-corrplots-cnj02-refined)B) correlations
for raw phenotypic measurements in population CNJ02, averaged over the
three sampling years, highlight a few moderate to strong correlations
that serve to guide subsequent analyses in QTL mapping. The 15 strongest
positive and negative inter-trait correlations for CNJ02 are shown in
barplot in figure \@ref(fig:trait-corrplots-cnj02-refined)C. Interesting
positive associations that emerge from the CNJ02 dataset include *SFY ×
TY*, *MFM × UBM*, *MFM × UMFM*, *UBM × UTBM*, and *MFM × UBW*. Although
not in the top 15 strongest positive correlations, *ULvW × UKLvW* shows
a moderately strong positive correlation (figure
\@ref(fig:trait-corrplots-cnj02), evidence that the largest berry shape
categorization (a subjective trait prone to error in recording) is
consistent with that of largest berry length versus width (an objective
trait that is easy to record). Interesting negative associations that
emerge from the CNJ02 dataset include *TY × PAC*, *UCLP × UCLS*, *SFY ×
PAC*, *SFY × Tacy*, *UNAB × PAC*, *MFM × PAC*, *MFM × UNAF*, and *MFM ×
UBBL*.

```{r trait-corrplots-cnj02-refined-annotate, echo=FALSE, message=FALSE, include=TRUE, eval=params$fig_gen_annotations}
    system2("misc/annotatefig.sh", args=c(paste0(params$workflow,"/traits/plots/corrplot.cnj02.refined.png"),"A"))
    system2("misc/annotatefig.sh", args=c(paste0(params$workflow,"/traits/plots/corrplot.cnj02.inv.refined.png"),"B"))
    system2("misc/annotatefig.sh", args=c(paste0(params$workflow,"/traits/plots/corrplot.cnj02.flat.png"),"C",45))
```

```{r trait-corrplots-cnj02-refined-montage, echo=FALSE, message=FALSE, include=TRUE, eval=params$fig_gen_montages}
    system2("montage", args=c("-background","white","-geometry","2048x2048+20+0","-tile","2x1",paste0(params$workflow,"/traits/plots/corrplot.cnj02.refined.A.png"), paste0(params$workflow,"/traits/plots/corrplot.cnj02.inv.refined.B.png"), paste0(params$workflow,"/traits/plots/corrplot.cnj02.refined.AB.png")))
    system2("montage", args=c("-background","white","-geometry","4096x2048+0+20","-tile","1x2",paste0(params$workflow,"/traits/plots/corrplot.cnj02.refined.AB.png"), paste0(params$workflow,"/traits/plots/corrplot.cnj02.flat.C.png"), paste0(params$workflow,"/traits/plots/corrplot.cnj02.refined.combined.png")))
```

```{r trait-corrplots-cnj02-refined, echo=FALSE, message=FALSE, include=TRUE, results='asis', out.width="95%", fig.show="hold", fig.align="center", fig.cap="Significant ($p < 0.5$) trait phenotype correlation heatmaps for boxed traits in population CNJ02, ordered by A) positive correlations and B) negative correlations.  C) Top 15 positive and negative correlations for CNJ04."}
    knitr::include_graphics(paste0(params$workflow,"/traits/plots/corrplot.cnj02.refined.combined.png"))
```

### CNJ04

Noteworthy inter-trait correlations in population CNJ04 are shown in
figure \@ref(fig:trait-corrplots-cnj04-refined), with the 15 most
salient positive and negative correlations shown in subplot C. Positive
associations that stand out include *SFY × TY*, *MFM × UBM*, *UBM ×
UBL*. Compared to CNJ02, CNJ04 has weaker correlations for traits *UBM x
UBW* (`r p.cnj04.c['UBM','UBW']` vs. `r p.cnj02.c['UBM','UBW']`) and
*UBM × UBL* (`r p.cnj04.c['UBM','UBL']` vs. `r p.cnj02.c['UBM','UBL']`), and is not in the top 15 positive correlatiosn
in figure \@ref(fig:trait-corrplots-cnj04-refined)C.
Interesting inter-trait negative correlations include *ULvW × UKSO*,
*Brix × UBL*, *PFR × UNB*, *Brix × UNS*.

```{r trait-corrplots-cnj04-refined-annotate, echo=FALSE, message=FALSE, include=TRUE, eval=params$fig_gen_annotations}
    system2("misc/annotatefig.sh", args=c(paste0(params$workflow,"/traits/plots/corrplot.cnj04.refined.png"),"A"))
    system2("misc/annotatefig.sh", args=c(paste0(params$workflow,"/traits/plots/corrplot.cnj04.inv.refined.png"),"B"))
    system2("misc/annotatefig.sh", args=c(paste0(params$workflow,"/traits/plots/corrplot.cnj04.flat.png"),"C",45))
```

```{r trait-corrplots-cnj04-refined-montage, echo=FALSE, message=FALSE, include=TRUE, eval=params$fig_gen_montages}
    system2("montage", args=c("-background","white","-geometry","2048x2048+20+0","-tile","2x1",paste0(params$workflow,"/traits/plots/corrplot.cnj04.refined.A.png"), paste0(params$workflow,"/traits/plots/corrplot.cnj04.inv.refined.B.png"), paste0(params$workflow,"/traits/plots/corrplot.cnj04.refined.AB.png")))
    system2("montage", args=c("-background","white","-geometry","4096x2048+0+20","-tile","1x2",paste0(params$workflow,"/traits/plots/corrplot.cnj04.refined.AB.png"), paste0(params$workflow,"/traits/plots/corrplot.cnj04.flat.C.png"), paste0(params$workflow,"/traits/plots/corrplot.cnj04.refined.combined.png")))
```

```{r trait-corrplots-cnj04-refined, echo=FALSE, message=FALSE, include=TRUE, results='asis', out.width="95%", fig.show="hold", fig.align="center", fig.cap="Significant ($p < 0.5$) trait phenotype correlation heatmaps for highlighted traits in population CNJ04, ordered by A) positive correlations and B) negative correlations.  C) Top 15 positive and negative correlations for CNJ04."}
    knitr::include_graphics(paste0(params$workflow,"/traits/plots/corrplot.cnj04.refined.combined.png"))
```

## Heritabilities

```{r h2-collate-summarize, echo=FALSE, message=FALSE, include=FALSE}
    #NOTE: The following code should be moved to QTLPipeline.Rmd
    cnj02.brcorrs <- read_csv(paste0(cnj02_workflow,"/traits/blups_raw_corrs.csv"))
    cnj02.h2 <- read_csv(paste0(cnj02_workflow,"/traits/h2.csv")) %>% 
                    select(model,label_short,h2)
    cnj02.ay.h2 <- cnj02.h2 %>% filter(model=='all-years') %>% arrange(desc(h2)) #Sort by descending h2 for all-years model
    cnj02.combined <- read_csv(paste0(cnj02_workflow,"/traits/h2.csv")) %>% 
                        left_join(cnj02.brcorrs, by=c("model","trait")) %>%
                        select(c(model,label_short,h2,brcorr)) %>%
                        pivot_longer(c(h2,brcorr), names_to="type", values_to="value") %>%
                        mutate(population="cnj02",
                               trait=factor(label_short, levels=rev(cnj02.ay.h2$label_short), ordered=TRUE),
                               type=factor(type, levels=c("brcorr","h2"), labels=c("Spearman ρ","Heritability")))
    cnj04.brcorrs <- read_csv(paste0(cnj04_workflow,"/traits/blups_raw_corrs.csv"))
    cnj04.h2 <- read_csv(paste0(cnj04_workflow,"/traits/h2.csv")) %>% 
                    select(model,label_short,h2)
    cnj04.ay.h2 <- cnj04.h2 %>% filter(model=='all-years') %>% arrange(desc(h2)) #Sort by descending h2 for all-years model
    cnj04.combined <- read_csv(paste0(cnj04_workflow,"/traits/h2.csv")) %>% 
                        left_join(cnj04.brcorrs, by=c("model","trait")) %>%
                        select(c(model,label_short,h2,brcorr)) %>%
                        pivot_longer(c(h2,brcorr), names_to="type", values_to="value") %>%
                        mutate(population="cnj04",
                               trait=factor(label_short, levels=rev(cnj04.ay.h2$label_short), ordered=TRUE),
                               type=factor(type, levels=c("brcorr","h2"), labels=c("Spearman ρ","Heritability")))
    cnj0x.h2.sum <- rbind(cnj02.h2,cnj04.h2) %>%
                    group_by(model, label_short) %>%
                    summarize(h2.min=min(h2),h2.max=max(h2),h2.mean=mean(h2))
    cnj0x.h2 <- cnj02.h2 %>%
                    inner_join(cnj04.h2, by=c("model","label_short"), suffix=c(".2",".4")) %>%
                    inner_join(cnj0x.h2.sum, by=c("model","label_short")) %>%
                    arrange(desc(h2.min))
    cnj0x.h2.all <- cnj0x.h2 %>%
                        filter(model=="all-years") %>%
                        mutate(h2.min=round(h2.min,digits=2)) %>%
                        mutate(trait=factor(label_short, levels=rev(label_short), ordered=TRUE))
    #The following are for inserting inline results in the text of the document
    cnj04.combined.ul.h2 <- round((cnj04.ay.h2 %>% filter(label_short == "UL"))$h2, digits=2)
    cnj04.combined.ul.brcorrs <- round((cnj04.brcorrs %>% filter(model == 'all-years') %>% filter(trait == "upright_length"))$brcorr, digits=2)

    load(paste0(cnj02_workflow,"/.RData.01_genBLUP"))
    model.collated.long.tb.2 <- model.collated.long.tb %>% mutate(population="cnj02")
    model.collated.long.stats.tb.2 <- model.collated.long.stats.tb %>% mutate(population="cnj02")
    model.collated.long.ylims.tb.2 <- model.collated.long.ylims.tb %>% mutate(population="cnj02")
    load(paste0(cnj04_workflow,"/.RData.01_genBLUP"))
    model.collated.long.tb.4 <- model.collated.long.tb %>% mutate(population="cnj04")
    model.collated.long.stats.tb.4 <- model.collated.long.stats.tb %>% mutate(population="cnj04")
    model.collated.long.ylims.tb.4 <- model.collated.long.ylims.tb %>% mutate(population="cnj04")

    model.collated.long.tb.both <- bind_rows(model.collated.long.tb.2,model.collated.long.tb.4) %>%
                                        filter(model == "all-years") %>% 
                                        filter(h2 != 0)
    model.collated.long.stats.tb.both <- bind_rows(model.collated.long.stats.tb.2,model.collated.long.stats.tb.4)
    model.collated.long.ylims.tb.both <- bind_rows(model.collated.long.ylims.tb.2,model.collated.long.ylims.tb.4)

    cnj0x.h2.top.all <- cnj0x.h2.all %>% 
                            filter(h2.min > 0.5) %>%
                            mutate(trait = factor(trait, levels=rev(trait)))

    #Reset workflow as it is overwritten
    workflow=params$workflow
```

For both populations, the highest heritabilities were found for the
upright yield-related traits and the plot traits (figure
\@ref(fig:trait-h2-cnj0x)). Generally, the *all year* models (equation
\@ref(eq:mm-year-ge)) had the highest heritabilities when compared to
the fitted models for individual years. Traits with consistently high
heritability in both populations are displayed in figure
\@ref(fig:h2-top) next to boxplots of their associated phenotypes and
BLUPs. The heritabilities are sorted from highest to lowest and
represent the minimum heritability between the two populations. The
BLUPs and phenotype boxplot distributions are standardized against the
raw phenotype trait values in order to demonstrate that models with
higher heritabilities encapsulate more of the phenotypic variation.
Trait *ULvW* has an extraordinarily high heritability in both
populations, followed by *UBL* and *UNS*. *Tacy*, a desirable trait
associated with fruit color, also shows evidence of high heritability.
High heritabilities in *UBM*, *UMFM*, and *TY* indicate strong potential
for selecting for higher yields in both of these two populations.
Although only modest, the heritability of traits like *SFY* and *PFR*
show some potential for selecting rot-resistant varieties for growing in
regions where berry rot is a problem. Fruit quality traits such as *TA*
and *Brix* show very low *all year* heritabilities in population CNJ02
but higher heritability in CNJ04.

Figure \@ref(fig:h2-brcorr) displays *all year* model heritabilities
sorted highest to lowest for each population separately next to the
calculated Spearman rank correlation coefficient for the genotype BLUPs
relative to their raw phenotypes. In spite of low heritability,
traits such as *UL* in CNJ04 continue to show moderate to strong
correlation between the BLUPs and their raw trait values (*e.g.*, $h^2
= $ `r cnj04.combined.ul.h2`, $ρ = $ `r cnj04.combined.ul.brcorrs`),
indicating that the models continue to maintain good genotype stability
when presented with traits that have incredibly low heritability and
that issues with genotype × environment interaction are minimal.

```{r h2-top-pre, echo=FALSE, message=FALSE, include=TRUE}
    p1 <- model.collated.long.tb.both %>% 
            filter(label_short %in% levels(cnj0x.h2.top.all$trait)) %>%
            mutate(label_short = factor(label_short, levels=rev(levels(cnj0x.h2.top.all$trait)), ordered=TRUE)) %>%
            filter(model == "all-years") %>% 
            ggplot(aes(x=valueZ, y=factor(population, levels=c("cnj04","cnj02"), labels=c("CNJ04","CNJ02"), ordered=TRUE))) +
            geom_boxplot(aes(fill=type), alpha=0.5, outlier.shape=NA, position=position_dodge(0.5)) +
            scale_y_discrete(position = "right") +
            facet_grid(rows=vars(label_short), switch="y") +
            theme_minimal() +
            theme(strip.text=element_blank(),
                axis.title = element_text(face="bold",size=14),
                axis.text.x  = element_text(size=12)) +
            labs(x="Standardized Values",
                y="",
                fill="Type") 

    p2 <- ggplot(cnj0x.h2.top.all, aes(x=h2.min,y=trait)) + 
            geom_bar(aes(fill=trait),stat="identity", alpha=0.75, show.legend=FALSE) +
            geom_text(aes(label=h2.min,fontface="bold"), nudge_x=0.025) +
            scale_y_discrete(position = "right") +
            theme_minimal() +
            theme(axis.title = element_text(face="bold",size=14),
                axis.text.y  = element_text(face="bold",size=16,angle=0),
                axis.text.x  = element_text(size=12)) +
            labs(x="Minimum Heritability",
                y="")

    p.combined <- plot_grid(p2,p1,rel_widths=c(1.5,1))
    ggsave(filename="../Data/publication/figures/cnj0x.h2.blupbox.top.png", plot=p.combined, device="png", bg="white", width=34, height=16.5, units="cm", dpi=300)
```

```{r h2-top, echo=FALSE, message=FALSE, include=TRUE, results='asis', out.width="95%", fig.show="hold", fig.align="center", fig.cap="Traits sorted by minimum heritabilities across both populations for *all years* model displayed next to their associated BLUP and phenotype distributions.  Only traits with minimum heritability above 0.5 are displayed."}
    knitr::include_graphics("../Data/publication/figures/cnj0x.h2.blupbox.top.png")
```

```{r h2-brcorr-plots, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE, eval=params$fig_gen_annotations}
    #NOTE: The following code should be moved to QTLPipeline.Rmd
    p2 <- ggplot(cnj02.combined %>% filter(model == "all-years"), aes(x=value, y=trait, group=factor(type), fill=type)) + 
        geom_bar(stat="identity", position=position_dodge(), alpha=0.75) +
        theme_minimal() +
        theme(plot.title = element_text(face="bold",size=14,hjust=0.5),
              axis.title = element_text(face="bold",size=12),
              legend.title = element_text(face="bold",size=11),
              axis.text.y  = element_text(size=10,angle=25),
              axis.text.x  = element_text(size=10,angle=60)) +
        labs(title="CNJ02",
             x="",
             y="Traits",
             fill="Type")
    ggsave(filename="../Data/publication/figures/cnj02.barplot.h2spearman.png", plot=p2, device="png", bg="white", width=12, height=20, units="cm", dpi=300)

    p4 <- ggplot(cnj04.combined %>% filter(model == "all-years"), aes(x=value, y=trait, group=factor(type), fill=type)) + 
        geom_bar(stat="identity", position=position_dodge(), alpha=0.75) +
        theme_minimal() +
        theme(plot.title = element_text(face="bold",size=14,hjust=0.5),
              axis.title = element_text(face="bold",size=12),
              legend.title = element_text(face="bold",size=11),
              axis.text.y  = element_text(size=10,angle=25),
              axis.text.x  = element_text(size=10,angle=60)) +
        labs(title="CNJ04",
             x="",
             y="Traits",
             fill="Type")
    ggsave(filename="../Data/publication/figures/cnj04.barplot.h2spearman.png", plot=p4, device="png", bg="white", width=12, height=20, units="cm", dpi=300)
```

```{r h2-brcorr-annotate, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE, eval=params$fig_gen_annotations}
    system2("misc/annotatefig.sh", args=c("../Data/publication/figures/cnj02.barplot.h2spearman.png","A"))
    system2("misc/annotatefig.sh", args=c("../Data/publication/figures/cnj04.barplot.h2spearman.png","B"))
```

```{r h2-brcorr-montage, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE, eval=params$fig_gen_montages}
    system2("montage", args=c("-background","white","-geometry","1421x2366+20+0","-tile","2x1","../Data/publication/figures/cnj02.barplot.h2spearman.A.png","../Data/publication/figures/cnj04.barplot.h2spearman.B.png","../Data/publication/figures/cnj0x.barplot.h2spearman.png"))
```

```{r h2-brcorr, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE, results='asis', out.width="95%", fig.show="hold", fig.align="center", fig.cap="Heritabilities and Spearman rank correlation coefficients (ρ) for traits in populations A) CNJ02 and B) CNJ04.  Correlation coefficients represent the associations between genotype BLUPs and their associated phenotypes for the *all years* mixed model."}
    knitr::include_graphics("../Data/publication/figures/cnj0x.barplot.h2spearman.png")
```

```{r trait-h2-cnj0x-def, echo=FALSE, message=FALSE, include=TRUE}
    imageA <- paste0(cnj02_workflow,"/traits/plots/h2_barplot.polar.upright_yield.cnj02.png")
    imageAA <- paste0(cnj02_workflow,"/traits/plots/h2_barplot.polar.upright_yield.cnj02.A.png")
    imageB <- paste0(cnj02_workflow,"/traits/plots/h2_barplot.polar.plot_traits.cnj02.png")
    imageBB <- paste0(cnj02_workflow,"/traits/plots/h2_barplot.polar.plot_traits.cnj02.B.png")
    imageC <- paste0(cnj04_workflow,"/traits/plots/h2_barplot.polar.upright_yield.cnj04.png")
    imageCC <- paste0(cnj04_workflow,"/traits/plots/h2_barplot.polar.upright_yield.cnj04.C.png")
    imageD <- paste0(cnj04_workflow,"/traits/plots/h2_barplot.polar.plot_traits.cnj04.png")
    imageDD <- paste0(cnj04_workflow,"/traits/plots/h2_barplot.polar.plot_traits.cnj04.D.png")
    imageCombined <- "../Data/publication/figures/h2_barplot.polar.cnj0x.png"

```

```{r trait-h2-cnj0x-annotate, echo=FALSE, message=FALSE, include=FALSE, eval=params$fig_gen_annotations}
    system2("misc/annotatefig.sh", args=c(imageA,"A"))
    system2("misc/annotatefig.sh", args=c(imageB,"B"))
    system2("misc/annotatefig.sh", args=c(imageC,"C"))
    system2("misc/annotatefig.sh", args=c(imageD,"D"))
```

```{r trait-h2-cnj0x-montage, echo=FALSE, message=FALSE, include=TRUE, eval=params$fig_gen_montages}
    system2("montage", args=c("-background","white","-geometry","3897x2952+20+20","-tile","2x2",imageAA,imageBB,imageCC,imageDD,imageCombined))
```

```{r trait-h2-cnj0x, echo=FALSE, message=FALSE, include=TRUE, results='asis', out.width="95%", fig.show="hold", fig.align="center", fig.cap="Heritabilities for upright-related yield traits (A and C) and plot-sampled traits (B and D) in populations CNJ02 (A and B) and CNJ04 (C and D)."}
    knitr::include_graphics("../Data/publication/figures/h2_barplot.polar.cnj0x.png")
```
## Breeding Value Estimates

Population CNJ02 and CNJ04 both displayed evidence of transgressive segregation in many of the traits.  Tables
\@ref(tab:blups-table-cnj02-all-top) and \@ref(tab:blups-table-cnj04-all-top) show summary statistics for traits and their
associated BLUPs for the *all year* model.  Rows are sorted by decreasing heritability, and only models with significant
genotypic effects (*p < 0.05*) and heritability above 0.5 are displayed.  Optimal model random effect terms used in
fitting each model are shown.  Raw trait associated statistics are subscripted with the letter *r*, and BLUP associated
statistics are subscripted with the letter *b* and are italicized.  The top and bottom five representative genotypes,
both for raw traits and for genotype BLUPs, are also shown.

### Summary Statistics 

```{r blups-table-cnj02-all-top, echo=FALSE, message=FALSE, include=TRUE, results='asis', out.width="75%"}
load(file=paste0(cnj02_workflow,"/.RData.01_genBLUP"))
full_tbl_reduced <- generateReducedTable(model.collated.summary.wide.tb %>% filter(model == 'all-years') %>% filter(h2 > 0.5) %>% filter(GLRpvalue < 0.05), caption="CNJ02 Population Trait and BLUP Summary for *all years* model with heritability above 0.5.  Only models with significant (*p < 0.05*) genotypic effects are displayed.")
full_tbl_reduced
```

```{r blups-table-cnj04-all-top, echo=FALSE, message=FALSE, include=TRUE, results='asis', out.width="75%"}
load(file=paste0(cnj04_workflow,"/.RData.01_genBLUP"))
full_tbl_reduced <- generateReducedTable(model.collated.summary.wide.tb %>% filter(model == 'all-years') %>% filter(h2 > 0.5) %>% filter(GLRpvalue < 0.05), caption="CNJ04 Population Trait and BLUP Summary for *all years* model with heritability above 0.5.  Only models with significant (*p < 0.05*) genotypic effects are displayed.")
full_tbl_reduced
```

### Genotype Rankings

```{r blups-plot-cnj0x-rank-sum-defs, echo=FALSE, message=FALSE, include=TRUE}
rank_blups <- function(blups, traits, direction=1, prop=.10) {
    o1 <- blups %>%
                filter(!(id %in% c(P1_Name,P2_Name))) %>%
                filter(label_short %in% traits) %>%
                filter(type == "BLUPs") %>%
                mutate(id=gsub(paste0(POP_Name,"_([0-9]+_[0-9]+)"),"g\\1",id)) %>%
                group_by(model,label_short)
    if( direction >= 0 ) {
        o2 <- o1 %>% slice_max(value,prop=prop)
    } else {
        o2 <- o1 %>% slice_min(value,prop=prop)
    }
    o3 <- o2 %>%
             ungroup() %>%
             group_by(model,label_short)
    if( direction >= 0 ) {
        o4 <- o3 %>% arrange(value, .by_group=TRUE)
    } else {
        o4 <- o3 %>% arrange(desc(value), .by_group=TRUE)
    }
    o5 <- o4 %>% 
             mutate(frank=1:length(id)) %>%
             ungroup()
    return(o5)
}

sum_ranks <- function(blups.ranked) {
    blups.sums <- blups.ranked %>% 
                  select(model,label_short,id,frank) %>% 
                  group_by(model,id) %>% 
                  summarize(rankcount=sum(frank)) %>%
                  arrange(desc(rankcount)) %>%
                  filter(model=="all-years") %>% 
                  mutate(id=factor(id, levels=id, ordered=TRUE))
    return(blups.sums)
}

plot_rank_sums <- function(blups.ranked, blups.sums, filename) {
    p <- ggplot(blups.ranked %>% filter(model == "all-years"), aes(x=frank, y=factor(id, levels=rev(blups.sums$id), ordered=TRUE), fill=label_short)) + 
            geom_bar(stat="identity", position=position_stack(), alpha=0.9) + 
            scale_fill_brewer(
                type="qual",
                palette="Paired") +
            theme_minimal() +
            theme(plot.title = element_text(face="bold",size=10,hjust=0.5),
                axis.title = element_text(face="bold",size=9,hjust=0.5),
                axis.text.x  = element_text(size=7),
                axis.text.y  = element_text(size=7),
                legend.text=element_text(size=8),
                legend.title=element_text(face="bold",size=10)) +
            labs(x="Rank Count",
                y="Genotype",
                fill="Trait",
                title=paste0(POP_Name," Rank Sum of Top 10 Percent Genotypes"))
    ggsave(filename=filename, plot=p, device="png", bg="white", width=12, height=20, units="cm", dpi=300)
}

imageA <- "../Data/publication/figures/cnj02.blups.rank_sums.png"
imageAA <- "../Data/publication/figures/cnj02.blups.rank_sums.A.png"
imageB <- "../Data/publication/figures/cnj04.blups.rank_sums.png"
imageBB <- "../Data/publication/figures/cnj04.blups.rank_sums.B.png"
imageCombined <- "../Data/publication/figures/cnj0x.blups.rank_sums.png"
```

```{r blups-plot-cnj02-rank-sum-plot, echo=FALSE, message=FALSE, include=TRUE}
load(file=paste0(cnj02_workflow,"/.RData.01_genBLUP"))
#Traits where higher values are preferred
positive_traits <- c("UBM","SFY","Tacy","MFM","UMFM")
#Traits where lower values are preferred
negative_traits <- c("ULvW","UKEC","PFR")

pts <- rank_blups(model.collated.long.tb, positive_traits)
nts <- rank_blups(model.collated.long.tb, negative_traits, direction=-1)
pnts <- bind_rows(pts,nts)
brs <- sum_ranks(pnts)
plot_rank_sums(pnts, brs, filename=imageA)
```

```{r blups-plot-cnj04-rank-sum-plot, echo=FALSE, message=FALSE, include=TRUE}
load(file=paste0(cnj04_workflow,"/.RData.01_genBLUP"))
#Traits where higher values are preferred
positive_traits <- c("UBM","SFY","Tacy","MFM","UMFM","Brix")
#Traits where lower values are preferred
negative_traits <- c("ULvW","UKEC","PFR")

pts <- rank_blups(model.collated.long.tb, positive_traits)
nts <- rank_blups(model.collated.long.tb, negative_traits, direction=-1)
pnts <- bind_rows(pts,nts)
brs <- sum_ranks(pnts)
plot_rank_sums(pnts, brs, filename="../Data/publication/figures/cnj04.blups.rank_sums.png")
workflow = "../Workflows/9" #Reset
```

```{r blups-plot-cnj0x-rank-sum-plot-annotate, echo=FALSE, message=FALSE, include=TRUE, eval=params$fig_gen_annotations}
    system2("misc/annotatefig.sh", args=c(imageA,"A"))
    system2("misc/annotatefig.sh", args=c(imageB,"B"))
```

```{r blups-plot-cnj0x-rank-sum-plot-montage, echo=FALSE, message=FALSE, include=TRUE, eval=params$fig_gen_montage}
    system2("montage", args=c("-background","white","-geometry","1425x2370+20+20","-tile","2x1",imageAA,imageBB,imageCombined))
```

A distribution of the top genotypes broken down by ranking the top BLUPs indicates a few strong candidates for selection in a breeding
program \@ref(fig:blups-plot-cnj0x-rank-sum-plot).  For population CNJ02, genotypes *CNJ02_1_38*, *CNJ02_1_82*, *CNJ02_1_17*,  *CNJ02_1_77*,  
and *CNJ02_1_57* have high combined BLUP ranking for largest berry traits such as *UBM* and *UMFM*, in addition to the mean fruit mass of 
the plot-sampled traits (*MFM*).  When considering other traits important to breeding, such as larger overall sound fruit yield (*SFY*) and low
fruit rot (*PFR*), genotype *CNJ02_1_118* shows promise.  Genotypes *CNJ02_1_138* and *CNJ02_1_100* are ideal nominees when
considering berry quality characteristics such as *Tacy* and rounder berries (low *UKEC* and low *ULvW*).  Because the
CNJ04 population is significantly smaller, less candidates are available with stacked traits.  However, *CNJ04_21_10*
and *CNJ04_2_5* shows excellent potential as selection candidates for berries with high *MFM* and largest berry mass
(*UBM*), while *CNJ04_21_10* has high ranking with A  *SFY*.  *CNJ04_21_32* combines high *Tacy* with high *MFM* and
rounder berries (low *ULvW*).  *CNJ04_2_24* combines high *Tacy* with low fruit rot (*PFR*), along with rounder berries
(low *UKEC* and low *ULvW*).  *CNJ04_2_12* stacks higher *Brix* with rounder berries (low *UKEC*).

```{r blups-plot-cnj0x-rank-sum-plot, echo=FALSE, message=FALSE, include=TRUE, results='asis', out.width="95%", fig.show="hold", fig.align="center", fig.cap="Rank-sum of top 10 percent of genotypes for a selected subset of trait BLUPs  for the *all year* model.  A) Population CNJ02 and b) Population CNJ04.  Genotype identifier is abbreviated: g<num> => CNJ02_<num>.  eg: g1_77 => CNJ02_1_77"}
    knitr::include_graphics(imageCombined)
```

## QTL Analyses

### CNJ02 

```{r qtl-table-defs, echo=FALSE, message=FALSE, include=TRUE}
qtls.cnj02.tb <- read_csv(paste0(cnj02_workflow,"/traits/effects_collated.csv"))
qtls.cnj02.s1.modv <- round(mean((qtls.cnj02.tb %>% filter(method=="scanone") %>% group_by(model) %>% summarize(model_variance=mean(model_variance)) %>% ungroup())$model_variance), digits=1)
qtls.cnj02.s1.markv <- round(mean((qtls.cnj02.tb %>% filter(method=="scanone") %>% group_by(model) %>% summarize(marker_variance=mean(marker_variance)) %>% ungroup())$marker_variance), digits=1)
qtls.cnj02.s1.nqtls <- round(mean((qtls.cnj02.tb %>% filter(method == "scanone") %>% nest_by(model,trait,chr,position) %>% group_by(model,trait) %>% summarize(nqtls=n()))$nqtls), digits=1) 
qtls.cnj02.s1.ntraits <- length(unique((qtls.cnj02.tb %>% filter(method == 'scanone') %>% group_by(model,trait) %>% summarize(marker_variance=mean(marker_variance)))$trait)) 
qtls.cnj02.sw.modv <- round(mean((qtls.cnj02.tb %>% filter(method=="stepwiseqtl") %>% group_by(model) %>% summarize(model_variance=mean(model_variance)) %>% ungroup())$model_variance), digits=1)
qtls.cnj02.sw.markv <- round(mean((qtls.cnj02.tb %>% filter(method=="stepwiseqtl") %>% group_by(model) %>% summarize(marker_variance=mean(marker_variance)) %>% ungroup())$marker_variance), digits=1)
qtls.cnj02.sw.nqtls <- round(mean((qtls.cnj02.tb %>% filter(method == "stepwiseqtl") %>% nest_by(model,trait,chr,position) %>% group_by(model,trait) %>% summarize(nqtls=n()))$nqtls), digits=1) 
qtls.cnj02.sw.ntraits <- length(unique((qtls.cnj02.tb %>% filter(method == 'stepwiseqtl'))$trait)) 
qtls.cnj02.sw.ints <- read_csv(paste0(cnj02_workflow,"/traits/qtl_collated.csv")) %>%
                            filter(method=="stepwiseqtl") %>%
                            filter(!is.na(chr2) & !is.na(position2))
qtls.cnj02.sw.ints.modv <- round(mean((qtls.cnj02.sw.ints %>% group_by(model) %>% summarize(model.variance=mean(model.variance)) %>% ungroup())$model.variance), digits=1)
qtls.cnj02.sw.ints.markv <- round(mean((qtls.cnj02.sw.ints %>% group_by(model) %>% summarize(marker.variance=mean(marker.variance)) %>% ungroup())$marker.variance), digits=1)
qtls.cnj02.sw.ints.nqtls <- round(mean((qtls.cnj02.sw.ints %>% nest_by(model,trait,chr,position) %>% group_by(model,trait) %>% summarize(nqtls=n()))$nqtls), digits=1) 
qtls.cnj02.sw.ints.ntraits <- length(unique((qtls.cnj02.sw.ints)$trait)) 
qtls.cnj02.sw.ay.ints <- qtls.cnj02.sw.ints %>%
                            filter(model=="all-years")
qtls.cnj02.sw.ay.nints <- nrow(qtls.cnj02.sw.ay.ints)
qtls.cnj02.sw.ay.ntraits <- length(unique(qtls.cnj02.sw.ay.ints$trait))
qtls.cnj02.sw.ay.markv <- round(mean(qtls.cnj02.sw.ay.ints$marker.variance, na.rm=T), digits=1)

qtls.cnj04.tb <- read_csv(paste0(cnj04_workflow,"/traits/effects_collated.csv"))
qtls.cnj04.s1.modv <- round(mean((qtls.cnj04.tb %>% filter(method=="scanone") %>% group_by(model) %>% summarize(model_variance=mean(model_variance)) %>% ungroup())$model_variance), digits=1)
qtls.cnj04.s1.markv <- round(mean((qtls.cnj04.tb %>% filter(method=="scanone") %>% group_by(model) %>% summarize(marker_variance=mean(marker_variance)) %>% ungroup())$marker_variance), digits=1)
qtls.cnj04.s1.nqtls <- round(mean((qtls.cnj04.tb %>% filter(method == "scanone") %>% nest_by(model,trait,chr,position) %>% group_by(model,trait) %>% summarize(nqtls=n()))$nqtls), digits=1) 
qtls.cnj04.s1.ntraits <- length(unique((qtls.cnj04.tb %>% filter(method == 'scanone') %>% group_by(model,trait) %>% summarize(marker_variance=mean(marker_variance)))$trait)) 
qtls.cnj04.sw.modv <- round(mean((qtls.cnj04.tb %>% filter(method=="stepwiseqtl") %>% group_by(model) %>% summarize(model_variance=mean(model_variance)) %>% ungroup())$model_variance), digits=1)
qtls.cnj04.sw.markv <- round(mean((qtls.cnj04.tb %>% filter(method=="stepwiseqtl") %>% group_by(model) %>% summarize(marker_variance=mean(marker_variance)) %>% ungroup())$marker_variance), digits=1)
qtls.cnj04.sw.nqtls <- round(mean((qtls.cnj04.tb %>% filter(method == "stepwiseqtl") %>% nest_by(model,trait,chr,position) %>% group_by(model,trait) %>% summarize(nqtls=n()))$nqtls), digits=1) 
qtls.cnj04.sw.ntraits <- length(unique((qtls.cnj04.tb %>% filter(method == 'stepwiseqtl'))$trait)) 
qtls.cnj04.sw.ints <- read_csv(paste0(cnj04_workflow,"/traits/qtl_collated.csv")) %>%
                            filter(method=="stepwiseqtl") %>%
                            filter(!is.na(chr2) & !is.na(position2))
qtls.cnj04.sw.ints.modv <- round(mean((qtls.cnj04.sw.ints %>% group_by(model) %>% summarize(model.variance=mean(model.variance)) %>% ungroup())$model.variance), digits=1)
qtls.cnj04.sw.ints.markv <- round(mean((qtls.cnj04.sw.ints %>% group_by(model) %>% summarize(marker.variance=mean(marker.variance)) %>% ungroup())$marker.variance), digits=1)
qtls.cnj04.sw.ints.nqtls <- round(mean((qtls.cnj04.sw.ints %>% nest_by(model,trait,chr,position) %>% group_by(model,trait) %>% summarize(nqtls=n()))$nqtls), digits=1) 
qtls.cnj04.sw.ints.ntraits <- length(unique((qtls.cnj04.sw.ints)$trait)) 
qtls.cnj04.sw.ay.ints <- qtls.cnj04.sw.ints %>%
                            filter(model=="all-years")
qtls.cnj04.sw.ay.nints <- nrow(qtls.cnj04.sw.ay.ints)
qtls.cnj04.sw.ay.ntraits <- length(unique(qtls.cnj04.sw.ay.ints$trait))
qtls.cnj04.sw.ay.markv <- round(mean(qtls.cnj04.sw.ay.ints$marker.variance, na.rm=T), digits=1)
```

For the CNJ02 population, we discovered an average of `r qtls.cnj02.s1.nqtls` QTL per *trait × model* combination  across `r qtls.cnj02.s1.ntraits` 
traits for the `scanone` method and `r qtls.cnj02.sw.nqtls` QTL per *trait × model* across `r qtls.cnj02.sw.ntraits` traits for the `stepwiseqtl` 
method.   The average `scanone` variance per QTL was `r qtls.cnj02.s1.markv` percent, with an average model variance of `r qtls.cnj02.s1.modv` 
percent.  The `mean stepwiseqtl` variance per QTL was `r qtls.cnj02.sw.markv` 
percent, with an average model variance of `r qtls.cnj02.sw.modv` percent.  A more detailed examination
of trait QTL, effect plots, LOD profiles, and trait correlations can be interrogated on the [CNJ02 QTL portal](https://vaccinium.vcru.wisc.edu/circos-cnj02/) 
webapp.

A summary of the top `stepwiseqtl` QTL discovered for the CNJ02 population for the *all years* model can be found in
Table \@ref(tab:qtl-table-cnj02-sw).  This summary of QTL only shows trait models with significant genotype effects and
heritability higher than 0.5, sorted from highest to lowest heritability (same trait order as \@ref(tab:blups-table-cnj02-all-top)).  From the marker
variance and effect plots, a few traits and their associated QTL of note emerge.  For largest upright *berry length*, linkage group 10 at
position 51.79cM, progeny display a 1.94mm advantage of allele *B* over *A* (maternal effect) and a 1.09mm advantage of *C*
over *D* (paternal effect), with progeny genotype *BC* showing the largest breeding advantage.  A similar pattern
emerges with the largest berry *number of seeds* on linkage group 6 (position 51.28cM),
although the *BC* genotype advantage is not as salient due to larger genotype variance and a lower mean interaction
effect.   For *total anthocyanins* (Tacy), linkage group 3, position 56.18cM shows a clear advantage in the *·D* genotype over
*·C* genotype, with an average higher Tacy content of around 12.6 mg units per 100 mg fruit.  As opposite sides of
the same coin, *sound fruit yield* and *percent fruit rot* have a collocated QTL on LG 11 (21.88cM and 17.25cM,
respectively) that appears to be have a noticeable impact on fruit rot in CNJ02.  CNJ02 progeny with genotype *AC* shows 
evidence of higher *sound fruit yield* and lower *percent fruit rot* than the other genotypes.  Largest *berry weight* and
*upright mean fruit mass* both have a QTL on LG 11 at position 30.32cM, with the average effect of allele *D* giving an
average 0.42 gram and 0.36 gram/berry advantage over allele *C*.  Plot *total yield* demonstrates and average allelic
effect of *C* over *D* of around 65 grams per square foot on linkage group 12 (position 48.76cM).  Given that the
genotypic effects for the upright berry *length versus width* were not found to be significant in the *all-year* model for
CNJ02, the berry *chimera length versus width* and *chimera eccentricity* represent good proxies.  A collocated QTL on 
linkage group 3 near 30cM for traits *chimera length versus width* and *chimera eccentricity* shows a
small, but statisically meaningful association such that genotype *BD* will produce rounder berries, an important
characteristic for fruit processing.


```{r qtl-table-cnj02-sw-setup, echo=FALSE, message=FALSE, include=FALSE}
load(file=paste0(cnj02_workflow,"/.RData.01_genBLUP"))
models.filtered <- model.collated.summary.wide.tb %>% 
                        filter(model == 'all-years') %>% 
                        filter(h2 > 0.5) %>% 
                        filter(GLRpvalue < 0.05) %>% 
                        arrange(desc(h2)) %>%
                        mutate(trait=factor(as.character(trait), levels=as.character(trait), ordered=TRUE))
```


```{r qtl-table-cnj02-sw, echo=FALSE, message=FALSE, include=TRUE, results='asis', out.width="85%"}
load(file=paste0(cnj02_workflow,"/.RData.12_geneffects.2"))
generateReducedTable(effs.complete.tb %>% 
                     filter(model=='all-years' &
                            method=='stepwiseqtl' &
                            trait %in% models.filtered$trait) %>% 
                     mutate(trait = factor(as.character(trait), levels=levels(models.filtered$trait), ordered=TRUE)) %>%
                     arrange(trait,desc(marker_variance)),
                     caption="CNJ02 Population Top 2 QTL for *all years* model, QTL fit using *stepwiseqtl()* function, with effect plots.  Only models with heritability > 0.5 and with significant genotypic effects (*p < 0.05*) are displayed.")
```

The `stepwiseqtl` method found an average of `r qtls.cnj02.sw.ints.nqtls` CNJ02 QTL:QTL interactions per *trait × model* combination  across `r qtls.cnj02.sw.ints.ntraits` 
traits, with an average model variance of `r qtls.cnj02.sw.ints.modv` percent and an average variance per QTL pair of `r qtls.cnj02.sw.ints.markv` percent.
The *all years* model found `r qtls.cnj02.sw.ay.nints` significant pairwise QTL:QTL interactions across `r qtls.cnj02.sw.ay.ntraits` traits, with an average variance per QTL pair of 
`r qtls.cnj02.sw.ay.markv` percent.  Table \@ref(tab:qtl-table-cnj02-sw-ints) summarizes the top significant pairwise QTL interactions for the *all years*
model.  The boxplots indicate the separate BLUP distributions grouped by pairwise QTL:QTL genotypes (subplot a), the first
QTL genotypes (subplot c), and the second QTL genotypes (subplot b).  For the pairwise QTL:QTL genotype
boxplots (subplot a), black diamond markers indicate the mean of the sum of the two QTL if considering their additive effect sizes
only, while the black circle markers indicate the mean pairwise QTL:QTL effect.  The horizontal distance, or bias,
between these means visually highlights the additional difference a QTL:QTL interaction imparts on the additive effects
of the two separate QTL.  The *MAD* metric, or *maximum average distance*, takes the maximum of all these biases, and *NMAD*
represents the normalized value of the *MAD* metric.  *MAD* highlights the most extreme value an QTL:QTL interaction can
impart on the additive effect, while *NMAD* gives a relative metric for comparing across traits with different units.

*Total anthocyanins* has the largest *NMAD* metric, with a maximum mean epistatic effect size of 4.591
$\frac{mg}{100g\ berries}$ due to a pairwise QTL interaction found on linkage groups 4 and 7.
*Number of seeds* is a close second, with a maximum mean epistatic effect size of 2.412 from a QTL interaction on
linkages groups 5 and 6.  Other interactions of note include those found for traits upright largest *berry weight* (*MAD*≈0.141g),
*upright mean fruit mass* (*MAD*≈0.114g/berry), and upright largest *berry width* (*MAD*≈0.164mm)(\@ref(tab:qtl-table-cnj02-sw-ints)).


```{r qtl-table-cnj02-sw-ints, echo=FALSE, message=FALSE, include=TRUE, results='asis', out.width="85%"}
load(file=paste0(cnj02_workflow,"/.RData.13_geninteffects.2"))
generateReducedTable(effs.ints.all.tb %>% 
                     filter(model=='all-years' &
                            trait %in% models.filtered$trait,
                            marker_variance >= 5.0) %>% 
                    mutate(trait = factor(as.character(trait), levels=levels(models.filtered$trait), ordered=TRUE)) %>%
                    group_by(trait) %>%
                    arrange(desc(marker_variance), .by_group = TRUE) %>%
                    slice_head() %>%
                    ungroup(),
                    caption="CNJ02 Population Top Interaction QTL for *All Years* model, QTL fit using *stepwiseqtl()* function.  Only models with heritability > 0.5, QTL with interaction percent variance explained greater than 5.0%, and models with significant genotypic effects (*p < 0.05*) are displayed.")
```

For yield-relevant traits, three linkage groups stand out: linkage groups 3, 10, and 11 (figure \@ref(fig:qtl-plot-cnj02)A).
The greatest set of collocated QTL is found on linkage group 3, with largest *berry length*, largest *berry weight*,
*plot mean fruit mass*, and *upright mean fruit mass* all found near 46-47cM.  Linkage group 10 is
noteable for having the highest number of large-effect yield QTL.  On linkage group 10, largest *berry length* and largest
*berry weight* are closely linked (52cM and 49cM, respectively), as are *plot mean fruit mass* and *upright mean
fruit mass* (39cM and 37cM, respectively).  Also within linkage group 10, large and signficant QTL can be found for
largest *berry width* (28cM), *length vs. width* (63cM), and upright *total berry weight* (43cM).  On linkage group
11, largest *berry weight* and *upright mean fruit mass* are collocated at 30cM, while plot mean fruit mass is closely
linked at 25cM.  QTL for largest *berry width* (40cM) and upright *length vs. width* (81cM) can also be found on
linkage group 11.

Berry chemistry trait QTL are highlighted in figure \@ref(fig:qtl-plot-cnj02)B.  There are no clear collocation patterns that
emerge as with the yield-related traits, not surprising given that the chemistry trait correlations were not as
strong as those of yield traits. Some of the traits and their QTL were discussed in reference to table
\@ref(tab:qtl-table-cnj02-sw).  A few non-chemistry traits cohabit chemistry traits in figure \@ref(fig:qtl-plot-cnj02)B because 
of their correlation with corresponding chemistry
traits.  For instance, *percent fruit rot* and *Tacy* have a moderately positive correlation (0.38), likely
related to large QTL closely linked on linkage group 7 (position 38cM and 33cM, respectively). 
These two traits share the same *BD* genotype for the highest positive effect.  The major QTL for *Tacy* found on
linkage group 3 is also linked to a large QTL for *plot mean fruit mass*, with allele *D* versus *C* showing a strong
positive *Tacy* effect and substantial negative *plot mean fruit mass* effect (table \@ref(tab:qtl-table-cnj02-sw)).  The largest QTL for *titratable acidity*, 
found on linkage group 2 at 50cM, appear to be closely linked with other traits' major QTL.   A closely
linked pair of QTL on linkage group 3 between *plot mean fruit mass* and *titratable acidity* could explain the
modest positive correlation between these two traits (0.40) (TODO - include correlation table supplemental reference).

```{r qtl-plot-cnj02-setup, echo=FALSE, message=FALSE, include=TRUE}
    imageA <- "../Data/publication/figures/cnj02.circos.yield.png"
    imageAA <- "../Data/publication/figures/cnj02.circos.yield.A.png"
    imageB <- "../Data/publication/figures/cnj02.circos.chemistry.png"
    imageBB <- "../Data/publication/figures/cnj02.circos.chemistry.B.png"
    imageCombined <- "../Data/publication/figures/cnj02.circos.png"
```

```{r qtl-plot-cnj02-annotate, echo=FALSE, message=FALSE, include=FALSE, eval=params$fig_gen_annotations}
    system2("misc/annotatefig.sh", args=c(imageA,"A"))
    system2("misc/annotatefig.sh", args=c(imageB,"B"))
```

```{r qtl-plot-cnj02-montage, echo=FALSE, message=FALSE, include=TRUE, eval=params$fig_gen_montages}
    system2("montage", args=c("-background","white","-geometry","2048x2048+20+0","-tile","2x1",imageAA,imageBB,imageCombined))
```

```{r qtl-plot-cnj02, echo=FALSE, message=FALSE, include=TRUE, results='asis', out.width="95%", fig.show="hold", fig.align="center", fig.cap="Notable QTL found in population CNJ02.  A) Yield-related traits.  B) Chemistry and chemistry-correlated traits."}
    knitr::include_graphics(imageCombined)
```

### CNJ04

Despite having a lower population size (*n = 72*), and thus lower power to find statistically significant QTL,
QTL were still found in CNJ04.  The CNJ04 population showed average of `r qtls.cnj04.s1.nqtls` QTL per *trait × model* combination  across `r qtls.cnj04.s1.ntraits` 
traits for the `scanone` method and `r qtls.cnj04.sw.nqtls` QTL per *trait × model* across `r qtls.cnj04.sw.ntraits` traits for the `stepwiseqtl` 
method.   The `scanone` average total BLUP variance explained per QTL was `r qtls.cnj04.s1.markv` percent, with an average BLUP variance explained by
all QTL per *trait × model* of `r qtls.cnj04.s1.modv` percent.  The `stepwiseqtl` average total BLUP variance explained per QTL was `r qtls.cnj04.sw.markv` 
percent, with an average BLUP variance explained by all QTL per *trait × model* of `r qtls.cnj04.sw.modv` percent.  A more detailed investigation 
of trait QTL, effect plots, LOD profiles, and trait correlations can be explored through the [CNJ04 QTL portal](https://vaccinium.vcru.wisc.edu/circos-cnj04/) 
webapp.


Similar to population CNJ02, a summary of the top 2 `stepwiseqtl` QTL for the *all years* 
model can be found in Table \@ref(tab:qtl-table-cnj04-sw), with traits sorted by decreasing heritability 
(same trait order as \@ref(tab:blups-table-cnj04-all-top)).  For largest upright berry *length vs. width*, linkage group
11, position 11.74cM, progeny with *BD* genotype demonstrate around 10 percent more roundness in berry shape.
A highly linked QTL in largest *berry length*, linkage group 11 and position 5.09cM, appears to be the main driver of this
lower *length vs. width* ratio.  For *Tacy*, although a QTL on linkage group 6 explains most of the genetic variation (10.08
percent) in the trait, linkage group 3 shows evidence of having an important role in explaining *Tacy* variation just as
in the CNJ02 population.  This QTL on linkage group 3, position 36.49cM, suggests that most of the variation is on the
paternal side, with a 14.21 $\frac{mg}{100mg\ fruit}$ advantage of allele *D* over *C* (figure \@ref(fig:qtl-plot-cnj04)B).  
Also as in CNJ02, the largest significant QTL for *total yield* is found on linkage group 12 and position 48.76cM, with genotype 
*AC* showing the largest genotype
effect.  Interestingly, despite having a moderate positive correlation with largest berry *length vs. width* (0.62), the
top two QTL for *chimera length v. width* are on linkage groups 4 (10.82cM) and 1 (14.48cM).  These QTL are closely linked
to other significant QTL found for *length vs. width* without appearing to be linked to QTL associated with *berry
width* or *berry length*, avoiding negative linkage drag ([supplemental link](#cnj04-qtl)).  If a lower overall acidity is
preferred, a significant QTL at linkage group 11, position 16.42cM, suggests that selecting genotype *BD* will help lower 
acidity in subsequent generations.  If wanting to select for higher *proanthocyanins* due to their beneficial effects on
human health, a QTL on linkage group 7, position 25.82cM, indicates a modest improvement by selecting *AC*.  Although
the absolute effect size is modest and the model variance explained by the QTL is small, *Brix* shows a modest advantage in
genotype *BC* (around 0.2 percent) on linkage group 9, position 84.81cM.  The very high correlation between *total
yield* and *sound fruit yield* (0.96) is consistent with these two traits sharing the same top 2 QTL.

For yield-relevant traits, linkage group 10 in the CNJ04 population has the largest number of top-tier QTL (figure \@ref(fig:qtl-plot-cnj04)A).
QTL of note on linkage group 10 not already mentioned include collocated *total yield* and *plot mean fruit mass*
(position 61cM) and the closely linked upright trait *total berry weight* (position 65cM).  These closely linked QTL
likely explain the modestly positive correlations (~0.5) between these traits.  Linkage group 9 has collocated QTL for
traits largest *berry weight* and upright *upright mean fruit mass* (position 58cM), closely linked with a large QTL for
largest *berry weight* (position 64cM).  


```{r qtl-table-cnj04-sw-setup, echo=FALSE, message=FALSE, include=FALSE}
load(file=paste0(cnj04_workflow,"/.RData.01_genBLUP"))
models.filtered <- model.collated.summary.wide.tb %>% 
                        filter(model == 'all-years') %>% 
                        filter(h2 > 0.5) %>% 
                        filter(GLRpvalue < 0.05) %>% 
                        arrange(desc(h2)) %>%
                        mutate(trait=factor(as.character(trait), levels=as.character(trait), ordered=TRUE))
```

```{r qtl-table-cnj04-sw, echo=FALSE, message=FALSE, include=TRUE, results='asis', out.width="85%"}
load(file=paste0(cnj04_workflow,"/.RData.12_geneffects.2"))
generateReducedTable(effs.complete.tb %>% 
                     filter(model=='all-years' &
                            method=='stepwiseqtl' &
                            trait %in% models.filtered$trait) %>% 
                     mutate(trait = factor(as.character(trait), levels=levels(models.filtered$trait), ordered=TRUE)) %>%
                     arrange(trait,desc(marker_variance)),
                     caption="CNJ04 Population Top 2 QTL for *all years* model, QTL fit using *stepwiseqtl()* function, with effect plots.  Only models with heritability > 0.5 and with significant genotypic effects (*p < 0.05*) are displayed.")
```

An average of `r qtls.cnj04.sw.ints.nqtls` CNJ04 QTL:QTL interactions per *trait × model* combination  across `r qtls.cnj04.sw.ints.ntraits` 
traits, with an average model variance of `r qtls.cnj04.sw.ints.modv` percent and an average variance per QTL pair of `r qtls.cnj04.sw.ints.markv` percent.
The *all years* model found `r qtls.cnj04.sw.ay.nints` significant pairwise QTL:QTL interactions across `r qtls.cnj04.sw.ay.ntraits` traits, with an average variance per QTL pair of 
`r qtls.cnj04.sw.ay.markv` percent.  Table \@ref(tab:qtl-table-cnj04-sw-ints) summarizes the top significant pairwise QTL interactions for the *all years*
model, with the same semantics of the subplots as defined for \@ref(tab:qtl-table-cnj02-sw-ints).  The number of
pairwise QTL interactions for the CNJ04 population was considerably lower than that of CNJ02 (`r qtls.cnj04.sw.ay.nints` vs. `r qtls.cnj02.sw.ay.nints`; predictable given its much
smaller population size.  None of the highest heritability traits with significant model genotype effects had
interaction variances above 5 percent.  Only one interaction is featured in table \@ref(tab:qtl-table-cnj04-sw-ints)
for QTL mapped across all years: *Brix*.  With a *MAD* metric of only 0.129°, this pairwise interaction on linkages
groups 6 and 11 would not likely pass on any meaningful effect on berry taste and quality.


```{r qtl-table-cnj04-sw-ints, echo=FALSE, message=FALSE, include=TRUE, results='asis', out.width="85%"}
load(file=paste0(cnj04_workflow,"/.RData.13_geninteffects.2"))
#is_html_output <- function() {TRUE}
generateReducedTable(effs.ints.all.tb %>% 
                     filter(model=='all-years' &
                            trait %in% models.filtered$trait) %>% 
                    mutate(trait = factor(as.character(trait), levels=levels(models.filtered$trait), ordered=TRUE)) %>%
                    group_by(trait) %>%
                    arrange(desc(marker_variance), .by_group = TRUE) %>%
                    slice_head() %>%
                    ungroup(),
                    caption="CNJ04 Population Top Interaction QTL for *all years* model, QTL fit using *stepwiseqtl()* function.  Only models with heritability > 0.5 and with significant genotypic effects (*p < 0.05*) are displayed.")
```

```{r qtl-plot-cnj04-setup, echo=FALSE, message=FALSE, include=TRUE}
    imageA <- "../Data/publication/figures/cnj04.circos.yield.png"
    imageAA <- "../Data/publication/figures/cnj04.circos.yield.A.png"
    imageB <- "../Data/publication/figures/cnj04.circos.chemistry.png"
    imageBB <- "../Data/publication/figures/cnj04.circos.chemistry.B.png"
    imageCombined <- "../Data/publication/figures/cnj04.circos.png"
```

```{r qtl-plot-cnj04-annotate, echo=FALSE, message=FALSE, include=FALSE, eval=params$fig_gen_annotations}
    system2("misc/annotatefig.sh", args=c(imageA,"A"))
    system2("misc/annotatefig.sh", args=c(imageB,"B"))
```

```{r qtl-plot-cnj04-montage, echo=FALSE, message=FALSE, include=TRUE, eval=params$fig_gen_montages}
    system2("montage", args=c("-background","white","-geometry","2048x2048+20+0","-tile","2x1",imageAA,imageBB,imageCombined))
```

```{r qtl-plot-cnj04, echo=FALSE, message=FALSE, include=TRUE, results='asis', out.width="95%", fig.show="hold", fig.align="center", fig.cap="Notable QTL found in population CNJ04.  A) Yield-related traits.  B) Chemistry and chemistry-correlated traits."}
    knitr::include_graphics(imageCombined)
```
